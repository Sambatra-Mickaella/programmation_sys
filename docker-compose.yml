version: "3.8"

services:
  server1:
    build:
      context: ./backend/server
    command: ["2121"]
    ports:
      - "2121:2121"
      - "2221:2221"
    volumes:
      - ./backend/server/resources:/app/resources
      - ./backend/server/shared_storage:/app/shared_storage
    restart: unless-stopped

  server2:
    build:
      context: ./backend/server
    command: ["2122"]
    ports:
      - "2122:2122"
      - "2222:2222"
    volumes:
      - ./backend/server/resources:/app/resources
      - ./backend/server/shared_storage:/app/shared_storage
    restart: unless-stopped

  server3:
    build:
      context: ./backend/server
    command: ["2123"]
    ports:
      - "2123:2123"
      - "2223:2223"
    volumes:
      - ./backend/server/resources:/app/resources
      - ./backend/server/shared_storage:/app/shared_storage
    restart: unless-stopped

  loadbalancer:
    build:
      context: ./backend/loadbalancer
    ports:
      - "2100:2100"
    volumes:
      - ./backend/loadbalancer/resources:/app/resources:ro
    environment:
      SMARTDRIVE_LB_CONFIG: /app/resources/lb_config.docker.json
    depends_on:
      - server1
      - server2
      - server3
    restart: unless-stopped
    

  javafx:
    build:
      context: ./backend/client
      dockerfile: Dockerfile.javafx
    depends_on:
      - loadbalancer
    environment:
      SMARTDRIVE_BACKEND_HOST: loadbalancer
      SMARTDRIVE_BACKEND_PORT: "2100"
      DISPLAY: "${DISPLAY:-:0}"
      GDK_BACKEND: x11
      LANG: C.UTF-8
      LC_ALL: C.UTF-8
      LANGUAGE: C.UTF-8
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix
      - ${HOME:-/tmp}:/host-home
    stdin_open: true
    tty: true
    restart: unless-stopped
